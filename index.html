<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. Electric of Tucson - Time Off Request</title>
    <script type="text/javascript">
        // Comprehensive debugging system - renamed from 'debugger' to avoid reserved keyword
        const logger = {
            logs: [],
            
            log: function(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}`;
                this.logs.push({message: logEntry, type: type});
                console.log(`%c${logEntry}`, this.getConsoleColor(type));
                this.updateDebugPanel();
            },
            
            getConsoleColor: function(type) {
                const colors = {
                    info: 'color: #00aaff',
                    success: 'color: #00ff00', 
                    warning: 'color: #ffaa00',
                    error: 'color: #ff4444'
                };
                return colors[type] || colors.info;
            },
            
            updateDebugPanel: function() {
                const logElement = document.getElementById('debugLog');
                if (logElement) {
                    logElement.innerHTML = this.logs.slice(-20).map(log => 
                        `<div class="debug-${log.type}">${log.message}</div>`
                    ).join('');
                    logElement.scrollTop = logElement.scrollHeight;
                }
            },
            
            updateStatus: function(element, message, type) {
                const el = document.getElementById(element);
                if (el) {
                    el.className = `debug-status debug-${type}`;
                    el.innerHTML = message;
                }
            }
        };
        
        // Global functions for debug panel
        window.toggleDebugger = function() {
            const panel = document.getElementById('debugPanel');
            const toggle = document.querySelector('.debug-toggle');
            if (panel && toggle) {
                if (panel.style.display === 'none' || !panel.style.display) {
                    panel.style.display = 'block';
                    toggle.textContent = '‚ùå Close';
                    runEnvironmentChecks();
                } else {
                    panel.style.display = 'none';
                    toggle.textContent = 'üêõ Debug';
                }
            }
        };
        
        window.runDiagnostics = function() {
            logger.logs = [];
            runEnvironmentChecks();
            
            // Additional comprehensive tests
            setTimeout(() => {
                logger.log('=== Comprehensive Diagnostics ===', 'info');
                logger.log(`Screen: ${screen.width}x${screen.height}`, 'info');
                logger.log(`Viewport: ${window.innerWidth}x${window.innerHeight}`, 'info');
                logger.log(`Timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}`, 'info');
                logger.log(`Language: ${navigator.language}`, 'info');
                logger.log(`Cookies enabled: ${navigator.cookieEnabled}`, 'info');
                logger.log(`Local storage: ${typeof Storage !== 'undefined'}`, 'info');
                logger.log('=== Diagnostics Complete ===', 'info');
            }, 2000);
        };
        
        function runEnvironmentChecks() {
            logger.log('=== Environment Diagnostics Started ===', 'info');
            
            // Check basic environment
            logger.log(`User Agent: ${navigator.userAgent}`, 'info');
            logger.log(`Page URL: ${window.location.href}`, 'info');
            logger.log(`Protocol: ${window.location.protocol}`, 'info');
            logger.log(`Domain: ${window.location.hostname}`, 'info');
            
            // Check if we're in an iframe/artifact
            if (window !== window.parent) {
                logger.log('‚ö†Ô∏è Running inside iframe/artifact - CDN requests may be blocked', 'warning');
                logger.updateStatus('envStatus', 'Environment: Iframe/Artifact (CDN Blocked)', 'warning');
            } else {
                logger.log('‚úÖ Running in main window', 'success');
                logger.updateStatus('envStatus', 'Environment: Main Window', 'success');
            }
            
            // Check HTTPS
            if (window.location.protocol === 'https:') {
                logger.log('‚úÖ HTTPS connection detected', 'success');
            } else {
                logger.log('‚ö†Ô∏è HTTP connection - may cause issues', 'warning');
            }
            
            // Test other components
            testForAdBlockers();
            testNetworkConnectivity();
            testEmailJSAvailability();
            testMailtoSupport();
        }
        
        function testForAdBlockers() {
            try {
                const testAd = document.createElement('div');
                testAd.innerHTML = '&nbsp;';
                testAd.className = 'adsbox';
                testAd.style.position = 'absolute';
                testAd.style.left = '-10000px';
                document.body.appendChild(testAd);
                
                setTimeout(() => {
                    try {
                        if (testAd.offsetHeight === 0) {
                            logger.log('‚ö†Ô∏è Ad blocker detected - may block external scripts', 'warning');
                        } else {
                            logger.log('‚úÖ No ad blocker interference detected', 'success');
                        }
                        document.body.removeChild(testAd);
                    } catch (e) {
                        logger.log('‚ö†Ô∏è Ad blocker test inconclusive', 'warning');
                    }
                }, 100);
            } catch (error) {
                logger.log('‚ö†Ô∏è Could not test for ad blockers: ' + error.message, 'warning');
            }
        }
        
        function testNetworkConnectivity() {
            logger.log('Testing network connectivity...', 'info');
            
            // Test basic connectivity
            if (navigator.onLine) {
                logger.log('‚úÖ Browser reports online status', 'success');
                logger.updateStatus('networkStatus', 'Network: Online', 'success');
            } else {
                logger.log('‚ùå Browser reports offline status', 'error');
                logger.updateStatus('networkStatus', 'Network: Offline', 'error');
                return;
            }
            
            // Test external resource loading
            try {
                const testImg = new Image();
                testImg.onload = () => {
                    logger.log('‚úÖ External resource loading works', 'success');
                    logger.updateStatus('networkStatus', 'Network: External Access OK', 'success');
                };
                testImg.onerror = () => {
                    logger.log('‚ùå External resource loading blocked', 'error');
                    logger.updateStatus('networkStatus', 'Network: External Access Blocked', 'error');
                };
                testImg.src = 'https://cdn.jsdelivr.net/favicon.ico?' + Date.now();
            } catch (error) {
                logger.log('‚ùå Network test failed: ' + error.message, 'error');
                logger.updateStatus('networkStatus', 'Network: Test Failed', 'error');
            }
        }
        
        function testEmailJSAvailability() {
            logger.log('Testing EmailJS availability...', 'info');
            
            if (typeof emailjs !== 'undefined') {
                logger.log('‚úÖ EmailJS already loaded', 'success');
                logger.updateStatus('emailjsStatus', 'EmailJS: Available', 'success');
                testEmailJSFunctionality();
            } else {
                logger.log('EmailJS not loaded, attempting dynamic load...', 'info');
                loadEmailJSForTesting();
            }
        }
        
        function loadEmailJSForTesting() {
            try {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
                script.onload = () => {
                    logger.log('‚úÖ EmailJS test load successful', 'success');
                    logger.updateStatus('emailjsStatus', 'EmailJS: Test Load OK', 'success');
                    testEmailJSFunctionality();
                };
                script.onerror = (error) => {
                    logger.log('‚ùå EmailJS test load failed', 'error');
                    logger.updateStatus('emailjsStatus', 'EmailJS: Test Load Failed', 'error');
                    
                    // Try fallback CDN
                    logger.log('Trying fallback CDN for test...', 'info');
                    const fallbackScript = document.createElement('script');
                    fallbackScript.src = 'https://unpkg.com/@emailjs/browser@4/dist/email.min.js';
                    fallbackScript.onload = () => {
                        logger.log('‚úÖ EmailJS fallback test load successful', 'success');
                        logger.updateStatus('emailjsStatus', 'EmailJS: Fallback Test OK', 'success');
                        testEmailJSFunctionality();
                    };
                    fallbackScript.onerror = () => {
                        logger.log('‚ùå All EmailJS test CDNs failed', 'error');
                        logger.updateStatus('emailjsStatus', 'EmailJS: All Test CDNs Failed', 'error');
                    };
                    document.head.appendChild(fallbackScript);
                };
                document.head.appendChild(script);
            } catch (error) {
                logger.log('‚ùå EmailJS test loading error: ' + error.message, 'error');
                logger.updateStatus('emailjsStatus', 'EmailJS: Load Error', 'error');
            }
        }
        
        function testEmailJSFunctionality() {
            if (typeof emailjs === 'undefined') {
                logger.log('‚ùå EmailJS object not available for testing', 'error');
                return;
            }
            
            try {
                emailjs.init({
                    publicKey: 'Istz4CM-PZQqIZPFY'
                });
                logger.log('‚úÖ EmailJS test initialization successful', 'success');
                
            } catch (error) {
                logger.log('‚ùå EmailJS test initialization failed: ' + error.message, 'error');
                logger.updateStatus('emailjsStatus', 'EmailJS: Test Init Failed', 'error');
            }
        }
        
        function testMailtoSupport() {
            logger.log('Testing mailto functionality...', 'info');
            
            try {
                const testMailto = 'mailto:test@example.com';
                const link = document.createElement('a');
                link.href = testMailto;
                
                if (link.protocol === 'mailto:') {
                    logger.log('‚úÖ Mailto protocol supported', 'success');
                    logger.updateStatus('mailtoStatus', 'Mailto: Supported', 'success');
                } else {
                    logger.log('‚ùå Mailto protocol not supported', 'error');
                    logger.updateStatus('mailtoStatus', 'Mailto: Not Supported', 'error');
                }
                
                // Test email client detection
                if (navigator.userAgent.includes('Mobile')) {
                    logger.log('üì± Mobile device detected - mailto should work', 'info');
                } else {
                    logger.log('üíª Desktop detected - mailto depends on email client', 'info');
                }
                
            } catch (error) {
                logger.log('‚ùå Mailto test failed: ' + error.message, 'error');
                logger.updateStatus('mailtoStatus', 'Mailto: Test Failed', 'error');
            }
        }
        
        // EmailJS loading system
        logger.log('Starting EmailJS loading process...', 'info');
        
        function loadEmailJSScript() {
            return new Promise((resolve, reject) => {
                logger.log('Attempting primary CDN: cdn.jsdelivr.net', 'info');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
                script.onload = () => {
                    logger.log('‚úÖ Primary CDN loaded successfully', 'success');
                    resolve();
                };
                script.onerror = (error) => {
                    logger.log('‚ùå Primary CDN failed', 'error');
                    
                    // Try fallback CDN
                    logger.log('Attempting fallback CDN: unpkg.com', 'info');
                    const fallbackScript = document.createElement('script');
                    fallbackScript.src = 'https://unpkg.com/@emailjs/browser@4/dist/email.min.js';
                    fallbackScript.onload = () => {
                        logger.log('‚úÖ Fallback CDN loaded successfully', 'success');
                        resolve();
                    };
                    fallbackScript.onerror = (fallbackError) => {
                        logger.log('‚ùå Fallback CDN failed', 'error');
                        reject(new Error('All CDNs failed'));
                    };
                    document.head.appendChild(fallbackScript);
                };
                document.head.appendChild(script);
            });
        }
        
        // Store the loading promise globally
        window.emailJSLoading = loadEmailJSScript();
        
        // Auto-start basic environment checks when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (document.getElementById('debugPanel')) {
                    runEnvironmentChecks();
                }
            }, 500);
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header::before {
            content: '‚ö°';
            position: absolute;
            top: 15px;
            left: 30px;
            font-size: 2em;
            opacity: 0.3;
        }
        
        .header::after {
            content: '‚ö°';
            position: absolute;
            top: 15px;
            right: 30px;
            font-size: 2em;
            opacity: 0.3;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            font-weight: 300;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-row {
            display: -ms-grid;
            display: grid;
            -ms-grid-columns: 1fr 20px 1fr;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-row > *:nth-child(1) { -ms-grid-column: 1; }
        .form-row > *:nth-child(2) { -ms-grid-column: 3; }
        
        label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .required {
            color: #ff6b35;
        }
        
        input[type="text"], 
        input[type="date"], 
        input[type="number"], 
        input[type="time"],
        select, 
        textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #fafafa;
            font-family: inherit;
        }
        
        input:focus, 
        select:focus, 
        textarea:focus {
            outline: none;
            border-color: #ff6b35;
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        input:invalid {
            border-color: #ef4444;
        }
        
        input:invalid:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        
        .radio-group {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            gap: 25px;
            margin-top: 10px;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
        }
        
        .radio-item {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            min-width: 120px;
        }
        
        .radio-item:hover {
            border-color: #ff6b35;
            background: white;
        }
        
        .radio-item.selected {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.05);
        }
        
        input[type="radio"] {
            width: 18px;
            height: 18px;
            margin: 0;
        }
        
        /* Custom radio button styling for better browser support */
        input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            background: white;
            position: relative;
        }
        
        input[type="radio"]:checked {
            border-color: #ff6b35;
            background: #ff6b35;
        }
        
        input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: white;
            transform: translate(-50%, -50%);
        }
        
        .warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 0.9em;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.1);
        }
        
        .info-box {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 0.9em;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.2em;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
            font-family: inherit;
        }
        
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 107, 53, 0.4);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .message {
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 600;
            display: none;
        }
        
        .loading {
            background: #f3f4f6;
            color: #374151;
            text-align: center;
        }
        
        .success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 4px solid #10b981;
            color: #065f46;
        }
        
        .error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }
        
        .validation-error {
            color: #ef4444;
            font-size: 0.875em;
            margin-top: 5px;
            display: none;
        }
        
        .section-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #374151;
            margin: 30px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #f3f4f6;
        }
        
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 350px;
            max-height: 80vh;
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            overflow-y: auto;
            z-index: 9999;
            display: none;
        }
        
        .debug-panel h4 {
            color: #ff6b35;
            margin: 0 0 10px 0;
            font-size: 12px;
        }
        
        .debug-log {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #333;
            padding: 5px;
        }
        
        .debug-status {
            margin-bottom: 8px;
            padding: 3px 0;
        }
        
        .debug-success { color: #00ff00; }
        .debug-warning { color: #ffaa00; }
        .debug-error { color: #ff4444; }
        .debug-info { color: #00aaff; }
        
        .debug-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ff6b35;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            z-index: 10000;
        }
        
        .section-title:first-child {
            margin-top: 0;
        }
        
        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus indicators for keyboard navigation */
        *:focus {
            outline: 2px solid #ff6b35;
            outline-offset: 2px;
        }
        
        .radio-item:focus-within {
            outline: 2px solid #ff6b35;
            outline-offset: 2px;
        }
        
        /* Media queries with fallbacks */
        @media screen and (max-width: 768px) {
            .form-row {
                -ms-grid-columns: 1fr;
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                -webkit-box-orient: vertical;
                -webkit-box-direction: normal;
                -ms-flex-direction: column;
                flex-direction: column;
                gap: 15px;
            }
            
            .container {
                margin: 10px;
            }
            
            .form-container {
                padding: 25px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.6em;
            }
            
            .header::before,
            .header::after {
                font-size: 1.5em;
                top: 10px;
            }
            
            .header::before {
                left: 20px;
            }
            
            .header::after {
                right: 20px;
            }
        }
        
        @media screen and (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .submit-btn {
                font-size: 1.1em;
                padding: 16px 30px;
            }
        }
    </style>
</head>
<body>
    <button class="debug-toggle" onclick="toggleDebugger()">üêõ Debug</button>
    
    <div class="debug-panel" id="debugPanel">
        <h4>üîç Mr. Electric Form Debugger</h4>
        
        <div class="debug-status" id="envStatus">Environment: Checking...</div>
        <div class="debug-status" id="emailjsStatus">EmailJS: Not tested</div>
        <div class="debug-status" id="mailtoStatus">Mailto: Not tested</div>
        <div class="debug-status" id="networkStatus">Network: Not tested</div>
        
        <h4>üìã Debug Log</h4>
        <div class="debug-log" id="debugLog"></div>
        
        <button onclick="runDiagnostics()" style="background: #333; color: white; border: 1px solid #666; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 10px;">Run Full Diagnostics</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>Mr. Electric of Tucson</h1>
            <p>Employee Time Off Request System</p>
        </div>
        
        <div class="form-container">
            <form id="timeOffForm" novalidate>
                <div class="section-title">Employee Information</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Employee Name <span class="required">*</span></label>
                        <input type="text" id="name" name="name" required minlength="2" maxlength="50">
                        <div class="validation-error" id="nameError">Please enter a valid name (2-50 characters)</div>
                    </div>
                    <div class="form-group">
                        <label for="requestDate">Request Submission Date <span class="required">*</span></label>
                        <input type="date" id="requestDate" name="requestDate" required>
                        <div class="validation-error" id="requestDateError">Please select a valid date</div>
                    </div>
                </div>
                
                <div class="section-title">Request Details</div>
                
                <div class="form-group">
                    <label>Request Type <span class="required">*</span></label>
                    <div class="radio-group" role="radiogroup" aria-labelledby="requestTypeLabel">
                        <div class="radio-item">
                            <input type="radio" id="absence" name="type" value="absence" required aria-describedby="requestTypeLabel">
                            <label for="absence">Full Day Absence</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="tardy" name="type" value="tardy" required aria-describedby="requestTypeLabel">
                            <label for="tardy">Partial Day / Tardy</label>
                        </div>
                    </div>
                    <div class="validation-error" id="typeError">Please select a request type</div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">Start Date <span class="required">*</span></label>
                        <input type="date" id="startDate" name="startDate" required>
                        <div class="validation-error" id="startDateError">Please select a valid start date</div>
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date (if multi-day)</label>
                        <input type="date" id="endDate" name="endDate">
                        <div class="validation-error" id="endDateError">End date must be after start date</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="startTime">Start Time</label>
                        <select id="startTime" name="startTime">
                            <option value="7:00 AM">7:00 AM</option>
                            <option value="8:00 AM" selected>8:00 AM</option>
                            <option value="12:00 PM">12:00 PM</option>
                            <option value="4:00 PM">4:00 PM</option>
                            <option value="Other">Other (specify in reason)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hours">Total Hours <span class="required">*</span></label>
                        <input type="number" id="hours" name="hours" step="0.25" min="0.25" max="24" required>
                        <div class="validation-error" id="hoursError">Please enter hours between 0.25 and 24</div>
                    </div>
                </div>
                
                <div class="section-title">Time Off Category</div>
                
                <div class="form-group">
                    <label>Category <span class="required">*</span></label>
                    <div class="radio-group" role="radiogroup" aria-labelledby="categoryLabel">
                        <div class="radio-item">
                            <input type="radio" id="unpaid" name="category" value="unpaid" required aria-describedby="categoryLabel">
                            <label for="unpaid">Unpaid Time Off</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="sick" name="category" value="sick" required aria-describedby="categoryLabel">
                            <label for="sick">Sick Leave</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="vacation" name="category" value="vacation" required aria-describedby="categoryLabel">
                            <label for="vacation">Vacation / PTO</label>
                        </div>
                    </div>
                    <div class="validation-error" id="categoryError">Please select a time off category</div>
                </div>
                
                <div class="warning">
                    <strong>‚ö†Ô∏è Important:</strong> Vacation/PTO is only available for employees with 1+ years of service. All requests require management approval through ADP.
                </div>
                
                <div class="info-box">
                    <strong>‚ÑπÔ∏è How it works:</strong> This form will attempt to send your request directly via email. If that's not available, it will open your email client with a pre-filled message. Either way, your request will reach management for ADP processing.
                </div>
                
                <div class="form-group">
                    <label for="reason">Reason for Request <span class="required">*</span></label>
                    <textarea id="reason" name="reason" rows="4" required minlength="5" maxlength="500" placeholder="Please provide a brief explanation for your time off request..."></textarea>
                    <div class="validation-error" id="reasonError">Please provide a reason (5-500 characters)</div>
                </div>
                
                <div class="message loading" id="loadingMessage">
                    <p>üìß Sending your request...</p>
                </div>
                
                <div class="message success" id="successMessage">
                    <p>‚úÖ Your time off request has been successfully submitted! Management will review and process it in ADP.</p>
                </div>
                
                <div class="message error" id="errorMessage">
                    <p>‚ùå There was an error submitting your request. Please try again or contact management directly.</p>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">Submit Time Off Request</button>
            </form>
        </div>
    </div>
    
    <script>
        (function() {
            'use strict';
            
            // Initialize EmailJS with comprehensive debugging
            let emailJSReady = false;
            
            function initEmailJS() {
                logger.log('Initializing EmailJS...', 'info');
                
                // Use the global loading promise
                if (window.emailJSLoading) {
                    window.emailJSLoading
                        .then(() => {
                            if (typeof emailjs !== 'undefined') {
                                try {
                                    emailjs.init({
                                        publicKey: 'Istz4CM-PZQqIZPFY'
                                    });
                                    emailJSReady = true;
                                    logger.log('‚úÖ EmailJS initialized successfully', 'success');
                                    logger.updateStatus('emailjsStatus', 'EmailJS: Ready', 'success');
                                } catch (error) {
                                    logger.log('‚ùå EmailJS initialization failed: ' + error.message, 'error');
                                    logger.updateStatus('emailjsStatus', 'EmailJS: Init Failed', 'error');
                                    emailJSReady = false;
                                }
                            } else {
                                logger.log('‚ùå EmailJS object not available after script load', 'error');
                                logger.updateStatus('emailjsStatus', 'EmailJS: Object Missing', 'error');
                                emailJSReady = false;
                            }
                        })
                        .catch((error) => {
                            logger.log('‚ùå EmailJS loading failed: ' + error.message, 'error');
                            logger.updateStatus('emailjsStatus', 'EmailJS: Load Failed', 'error');
                            emailJSReady = false;
                        });
                } else {
                    logger.log('‚ùå EmailJS loading promise not available', 'error');
                    logger.updateStatus('emailjsStatus', 'EmailJS: No Loading Promise', 'error');
                    emailJSReady = false;
                }
            }
            
            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initEmailJS);
            } else {
                initEmailJS();
            }
            
                // Enhanced fallback mailto function with debugging
                function sendMailtoFallback(data) {
                    logger.log('Attempting mailto fallback...', 'info');
                    
                    try {
                        const emailBody = [
                            'Mr. Electric of Tucson - Time Off Request',
                            '',
                            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                            'EMPLOYEE INFORMATION',
                            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                            'Employee Name: ' + data.name,
                            'Request Submitted: ' + data.requestDate,
                            '',
                            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                            'REQUEST DETAILS',
                            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                            'Request Type: ' + data.type.charAt(0).toUpperCase() + data.type.slice(1),
                            'Start Date: ' + data.startDate,
                            'End Date: ' + (data.endDate || 'Same day'),
                            'Start Time: ' + data.startTime,
                            'Total Hours: ' + data.hours,
                            '',
                            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                            'CATEGORY & DETAILS',
                            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                            'Time Off Category: ' + data.category.toUpperCase(),
                            data.category === 'vacation' ? '‚ö†Ô∏è VACATION REQUEST - Please verify employee has 1+ years of service' : '',
                            '',
                            'Reason for Request:',
                            data.reason,
                            '',
                            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                            'ACTION REQUIRED',
                            '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                            'Please process this request in the ADP system.',
                            '',
                            'Submitted via Mr. Electric Time Off Request Form'
                        ].filter(Boolean).join('\n');
                        
                        const subject = 'Time Off Request - ' + data.name + ' - ' + data.startDate;
                        const mailto = 'mailto:support@mrelectricoftucson.com?subject=' + 
                            encodeURIComponent(subject) + '&body=' + encodeURIComponent(emailBody);
                        
                        logger.log('Mailto URL length: ' + mailto.length + ' characters', 'info');
                        logger.log('Attempting to open email client...', 'info');
                        
                        // Try to open mailto
                        window.location.href = mailto;
                        
                        // Test if mailto worked by checking if window is still focused
                        setTimeout(() => {
                            if (document.hasFocus()) {
                                logger.log('‚ö†Ô∏è Window still focused - mailto may not have worked', 'warning');
                                showManualEmailInstructions(data);
                            } else {
                                logger.log('‚úÖ Window lost focus - email client likely opened', 'success');
                                logger.updateStatus('mailtoStatus', 'Mailto: Opened Successfully', 'success');
                            }
                        }, 1000);
                        
                        return true;
                        
                    } catch (error) {
                        logger.log('‚ùå Mailto failed: ' + error.message, 'error');
                        logger.updateStatus('mailtoStatus', 'Mailto: Failed - ' + error.message, 'error');
                        showManualEmailInstructions(data);
                        return false;
                    }
                }
                
                function showManualEmailInstructions(data) {
                    logger.log('Showing manual email instructions...', 'warning');
                    
                    const instructions = document.createElement('div');
                    instructions.style.cssText = `
                        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: white; padding: 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        max-width: 500px; max-height: 80vh; overflow-y: auto; z-index: 1000;
                        border: 2px solid #ff6b35;
                    `;
                    instructions.innerHTML = `
                        <h3 style="color: #ff6b35; margin-bottom: 15px;">üìß Manual Email Required</h3>
                        <p style="margin-bottom: 15px;"><strong>Both automatic methods failed.</strong><br>Please manually send an email to:</p>
                        <p style="background: #f3f4f6; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-family: monospace;">
                            <strong>support@mrelectricoftucson.com</strong>
                        </p>
                        <p style="margin-bottom: 10px;"><strong>Subject:</strong> Time Off Request - ${data.name} - ${data.startDate}</p>
                        <div style="background: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px;">
                            <strong>Include these details:</strong><br>
                            ‚Ä¢ Employee: ${data.name}<br>
                            ‚Ä¢ Type: ${data.type}<br>
                            ‚Ä¢ Start Date: ${data.startDate}<br>
                            ‚Ä¢ Hours: ${data.hours}<br>
                            ‚Ä¢ Category: ${data.category}<br>
                            ‚Ä¢ Reason: ${data.reason}
                        </div>
                        <button onclick="this.parentElement.remove()" style="
                            background: #ff6b35; color: white; border: none; padding: 10px 20px; 
                            border-radius: 5px; cursor: pointer; font-weight: 600; margin-right: 10px;
                        ">Got it!</button>
                        <button onclick="window.toggleDebugger()" style="
                            background: #666; color: white; border: none; padding: 10px 20px; 
                            border-radius: 5px; cursor: pointer; font-weight: 600;
                        ">View Debug Info</button>
                    `;
                    document.body.appendChild(instructions);
                    
                    logger.updateStatus('mailtoStatus', 'Mailto: Manual Instructions Shown', 'warning');
                }
            
            // Set today's date as default
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            document.getElementById('requestDate').value = todayString;
            
            // Set minimum date for start date (allow 30 days in past)
            const minDate = new Date();
            minDate.setDate(minDate.getDate() - 30);
            const minDateString = minDate.toISOString().split('T')[0];
            document.getElementById('startDate').setAttribute('min', minDateString);
            
            // Set maximum date (1 year in future)
            const maxDate = new Date();
            maxDate.setFullYear(maxDate.getFullYear() + 1);
            const maxDateString = maxDate.toISOString().split('T')[0];
            document.getElementById('startDate').setAttribute('max', maxDateString);
            document.getElementById('endDate').setAttribute('max', maxDateString);
            
            // Utility functions
            function showError(fieldId, message) {
                const errorElement = document.getElementById(fieldId + 'Error');
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                }
            }
            
            function hideError(fieldId) {
                const errorElement = document.getElementById(fieldId + 'Error');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
            }
            
            function hideAllErrors() {
                const errorElements = document.querySelectorAll('.validation-error');
                errorElements.forEach(function(element) {
                    element.style.display = 'none';
                });
            }
            
            function sanitizeInput(input) {
                return input.replace(/[<>]/g, '');
            }
            
            function showMessage(type) {
                // Hide all messages first
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('successMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                
                // Show the requested message
                const messageElement = document.getElementById(type + 'Message');
                if (messageElement) {
                    messageElement.style.display = 'block';
                }
            }
            
            // Form validation functions
            function validateName(name) {
                return name && name.length >= 2 && name.length <= 50;
            }
            
            function validateDate(dateString) {
                if (!dateString) return false;
                const date = new Date(dateString);
                const now = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(now.getDate() - 30);
                const oneYearFromNow = new Date();
                oneYearFromNow.setFullYear(now.getFullYear() + 1);
                
                return date >= thirtyDaysAgo && date <= oneYearFromNow;
            }
            
            function validateHours(hours) {
                const num = parseFloat(hours);
                return !isNaN(num) && num >= 0.25 && num <= 24;
            }
            
            function validateReason(reason) {
                return reason && reason.length >= 5 && reason.length <= 500;
            }
            
            // Handle radio button styling
            function handleRadioSelection() {
                document.querySelectorAll('input[type="radio"]').forEach(function(radio) {
                    radio.addEventListener('change', function() {
                        const groupName = this.name;
                        // Remove selected class from all radio items in the same group
                        document.querySelectorAll('input[name="' + groupName + '"]').forEach(function(r) {
                            const radioItem = r.closest('.radio-item');
                            if (radioItem) {
                                radioItem.classList.remove('selected');
                            }
                        });
                        // Add selected class to current item
                        const currentItem = this.closest('.radio-item');
                        if (currentItem) {
                            currentItem.classList.add('selected');
                        }
                        
                        // Hide validation error for this group
                        hideError(groupName);
                    });
                });
            }
            
            // Initialize radio button handling
            handleRadioSelection();
            
            // Auto-calculate end date for single day requests
            document.getElementById('startDate').addEventListener('change', function() {
                const endDateField = document.getElementById('endDate');
                const startDate = new Date(this.value);
                
                // Set minimum end date to start date
                endDateField.setAttribute('min', this.value);
                
                // If no end date is set, default to same as start date
                if (!endDateField.value) {
                    endDateField.value = this.value;
                }
                
                // Validate date
                if (validateDate(this.value)) {
                    hideError('startDate');
                } else {
                    showError('startDate', 'Please select a date within the allowed range');
                }
            });
            
            // Validate end date when changed
            document.getElementById('endDate').addEventListener('change', function() {
                const startDate = document.getElementById('startDate').value;
                if (startDate && this.value && new Date(this.value) < new Date(startDate)) {
                    showError('endDate', 'End date must be after start date');
                } else {
                    hideError('endDate');
                }
            });
            
            // Smart hour suggestions based on request type
            document.querySelectorAll('input[name="type"]').forEach(function(radio) {
                radio.addEventListener('change', function() {
                    const hoursField = document.getElementById('hours');
                    if (this.value === 'absence') {
                        hoursField.value = '8';
                    } else if (this.value === 'tardy') {
                        hoursField.value = '2';
                    }
                });
            });
            
            // Real-time validation
            document.getElementById('name').addEventListener('blur', function() {
                if (!validateName(this.value.trim())) {
                    showError('name', 'Please enter a valid name (2-50 characters)');
                } else {
                    hideError('name');
                }
            });
            
            document.getElementById('hours').addEventListener('blur', function() {
                if (!validateHours(this.value)) {
                    showError('hours', 'Please enter hours between 0.25 and 24');
                } else {
                    hideError('hours');
                }
            });
            
            document.getElementById('reason').addEventListener('blur', function() {
                if (!validateReason(this.value.trim())) {
                    showError('reason', 'Please provide a reason (5-500 characters)');
                } else {
                    hideError('reason');
                }
            });
            
            // Prevent double submission
            let isSubmitting = false;
            
            // Handle form submission
            document.getElementById('timeOffForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Prevent double submission
                if (isSubmitting) {
                    return;
                }
                
                hideAllErrors();
                
                const formData = new FormData(this);
                const data = {};
                
                // Collect and sanitize form data
                for (let [key, value] of formData.entries()) {
                    data[key] = sanitizeInput(value.toString().trim());
                }
                
                // Comprehensive validation
                let isValid = true;
                
                if (!validateName(data.name)) {
                    showError('name', 'Please enter a valid name (2-50 characters)');
                    isValid = false;
                }
                
                if (!data.requestDate) {
                    showError('requestDate', 'Please select a request date');
                    isValid = false;
                }
                
                if (!data.type) {
                    showError('type', 'Please select a request type');
                    isValid = false;
                }
                
                if (!validateDate(data.startDate)) {
                    showError('startDate', 'Please select a valid start date');
                    isValid = false;
                }
                
                if (data.endDate && new Date(data.endDate) < new Date(data.startDate)) {
                    showError('endDate', 'End date must be after start date');
                    isValid = false;
                }
                
                if (!validateHours(data.hours)) {
                    showError('hours', 'Please enter hours between 0.25 and 24');
                    isValid = false;
                }
                
                if (!data.category) {
                    showError('category', 'Please select a time off category');
                    isValid = false;
                }
                
                if (!validateReason(data.reason)) {
                    showError('reason', 'Please provide a reason (5-500 characters)');
                    isValid = false;
                }
                
                if (!isValid) {
                    // Focus on first error field
                    const firstError = document.querySelector('.validation-error[style*="block"]');
                    if (firstError) {
                        const fieldId = firstError.id.replace('Error', '');
                        const field = document.getElementById(fieldId) || document.querySelector('input[name="' + fieldId + '"]');
                        if (field) {
                            field.focus();
                        }
                    }
                    return;
                }
                
                // Vacation eligibility check
                if (data.category === 'vacation') {
                    if (!confirm('Please confirm that ' + data.name + ' has 1+ years of service for vacation eligibility.\n\nClick OK to confirm and proceed, or Cancel to review.')) {
                        return;
                    }
                }
                
                // Set submission flag
                isSubmitting = true;
                
                // Show loading state
                showMessage('loading');
                document.getElementById('submitBtn').disabled = true;
                
                // Prepare email template parameters
                const templateParams = {
                    employee_name: data.name,
                    request_date: data.requestDate,
                    request_type: data.type.charAt(0).toUpperCase() + data.type.slice(1),
                    start_date: data.startDate,
                    end_date: data.endDate || 'Same day',
                    start_time: data.startTime,
                    total_hours: data.hours,
                    category: data.category.toUpperCase(),
                    reason: data.reason,
                    formatted_request: [
                        'Time Off Request Details:',
                        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
                        '',
                        'Employee: ' + data.name,
                        'Request Submitted: ' + data.requestDate,
                        'Request Type: ' + data.type.charAt(0).toUpperCase() + data.type.slice(1),
                        '',
                        'SCHEDULE DETAILS:',
                        'Start Date: ' + data.startDate,
                        'End Date: ' + (data.endDate || 'Same day'),
                        'Start Time: ' + data.startTime,
                        'Total Hours: ' + data.hours,
                        '',
                        'CATEGORY: ' + data.category.toUpperCase(),
                        data.category === 'vacation' ? '‚ö†Ô∏è VACATION REQUEST - Verify employee has 1+ years service' : '',
                        '',
                        'REASON:',
                        data.reason,
                        '',
                        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
                        'Please process this request in ADP system.'
                    ].filter(Boolean).join('\n')
                };
                
                // Check if EmailJS is ready
                if (!emailJSReady) {
                    console.error('EmailJS not available');
                    showMessage('error');
                    setTimeout(function() {
                        showMessage('');
                        isSubmitting = false;
                        document.getElementById('submitBtn').disabled = false;
                    }, 5000);
                    return;
                }
                
                // Send email using EmailJS
                emailjs.send('default_service', 'template-617524g', templateParams)
                    .then(function(response) {
                        console.log('Email sent successfully:', response.status, response.text);
                        
                        // Show success message
                        showMessage('success');
                        
                        // Reset form after successful submission
                        setTimeout(function() {
                            document.getElementById('timeOffForm').reset();
                            document.getElementById('requestDate').value = todayString;
                            document.querySelectorAll('.radio-item').forEach(function(item) {
                                item.classList.remove('selected');
                            });
                            showMessage('');
                            isSubmitting = false;
                            document.getElementById('submitBtn').disabled = false;
                        }, 4000);
                        
                    })
                    .catch(function(error) {
                        console.error('Email send failed:', error);
                        
                        // Show error message
                        showMessage('error');
                        
                        // Re-enable form after error
                        setTimeout(function() {
                            showMessage('');
                            isSubmitting = false;
                            document.getElementById('submitBtn').disabled = false;
                        }, 5000);
                    });
            });
            
            // Initialize form on page load
            document.addEventListener('DOMContentLoaded', function() {
                // Focus on first field for better UX
                document.getElementById('name').focus();
            });
            
        })();
    </script>
</body>
</html>
